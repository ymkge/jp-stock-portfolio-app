# 国内株式ポートフォリオ管理アプリ (jp-stock-portfolio-app)
<img width="1910" height="960" alt="スクリーンショット 2026-02-06 20 08 09" src="https://github.com/user-attachments/assets/fcc497c9-7c71-44af-aadd-d8c3d27128ee" />


## 概要

ユーザーが管理する国内株式、米国株式、投資信託のポートフォリオに基づき、株価や財務指標、配当履歴などをYahoo!ファイナンスから取得し、Webページに一覧表示するシングルページアプリケーション（SPA）です。
各指標が割安か割高かを視覚的に判断するためのサポート機能も搭載しています。

## 主な機能

- **銘柄一覧表示**: 登録された銘柄の各種情報をリアルタイムで取得し、テーブル形式で表示します。
- **決算月表示**: 国内株式・米国株式について、ポートフォリオ一覧に各銘柄の決算月を表示し、権利確定日などの参考情報として活用できます。
- **複数口座対応の保有情報管理**: 1つの銘柄に対して、複数の口座（特定、一般、旧NISA、新NISAなど）での保有情報を個別に管理できます。口座ごとに取得単価と数量を記録し、評価額、損益、損益率、年間配当予想を自動で計算・表示します。
- **ポートフォリオ分析**: 保有銘柄のみを対象とした分析ページで、ポートフォリオ全体のサマリー、保有口座ごとの詳細一覧、業種別・口座種別・**証券会社別**・国別ごとの保有比率を円グラフで視覚的に確認できます。さらに、**ポートフォリオ全体の「DNA（加重平均指標）」や「分散度（HHI指数）」、景気特性やスタイルを判定する「性格診断」機能**により、資産全体の傾向を多角的に分析可能です。このページの保有銘柄一覧は、各項目でのソートに加え、銘柄コード/銘柄名でのテキスト検索、業種・口座種別・**証券会社**でのドロップダウンフィルタを組み合わせた柔軟な絞り込みが可能です。さらに、プライバシー保護のため、ページ上のすべての金額表示（評価額、損益など）をワンクリックで隠す「目隠し機能」も備えています。
- **指標ハイライト**: PERやPBRなどの指標が、設定ファイル(`highlight_rules.json`)の基準に応じて色付けされ、割安・割高が一目で分かります。
- **総合評価スコア**: 複数の指標（PER, PBR, ROE, 利回り, **連続増配**, **トレンド**, **フィボナッチ**, **RCI**）を総合的に評価した「スコア」を**最大15点**の星印で表示し、銘柄の魅力を多角的に判断できます。
    - **色分け表示**: 指標の種類に応じて星の色を分けて表示します。
        - **ファンダメンタルズ評価**（PER, PBR, ROE, 利回り, 連続増配）: **黄色**の星（★）
        - **トレンド評価**（移動平均線との乖離など）: **青色**の星（★）
- **ポートフォリオ特性分析 (Portfolio DNA & Risk)**: [新機能]
    - **ポートフォリオのDNA**: 保有額の大きさを考慮した「加重平均」により、資産全体の平均PER、PBR、ROE、利回りを算出。ポートフォリオが市場平均に対してどの程度割安か、収益性が高いかを客観視できます。
    - **分散度・リスク分析**: 特定銘柄への集中度を測る「HHI指数」と「上位5銘柄占有率」を算出。分散が効いているか（良好）、特定の銘柄に依存しすぎていないか（集中リスク）を診断します。
- **ポートフォリオ性格診断 (Style Analysis)**: [新機能]
    - **スタイル判定**: 保有銘柄の属性から「景気特性（景気敏感/ディフェンシブ）」「投資スタイル（バリュー/グロース）」「時価総額（大型/中小型）」の比率を可視化します。
    - **一言診断**: 分析結果に基づき、「大型株中心のディフェンシブ寄りバリュー」といった簡易的なポートフォリオの性格診断メッセージを表示します。
- **ポートフォリオ特性 (Radar Chart)**: [新機能]
    - **多角的な視覚化**: 「割安性」「収益性」「インカム」「クオリティ」「分散度」「安全性」の6つの軸でポートフォリオのバランスを可視化します。
    - **ベンチマーク比較**: 市場平均（ベンチマーク）を点線で重ねて表示し、自分のポートフォリオが市場に対してどのような強み・弱みを持っているかをひと目で把握できます。
- **連続増配分析**: 過去10年間の配当データから**連続増配年数**（前期比で増配している年数）を自動で計算し、バッジで表示します。詳細な配当履歴はツールチップで確認できます。
- **銘柄追加・削除**: 銘柄コードを指定して、ポートフォリオの銘柄を管理します。複数銘柄の一括削除、および直近追加した銘柄10件のリスト表示・入力補助機能も搭載しています。
- **ソート機能**: ポートフォリオ一覧および分析ページの保有銘柄一覧の各項目をクリックすることで、データを昇順・降順に並び替えることができます。銘柄コードや銘柄名でのリアルタイムフィルタリング機能も利用可能です。
- **外部リンク**: 銘柄名や連続増配バッジをクリックすると、Yahoo!ファイナンスの該当ページを新しいタブで開きます。
- **CSVダウンロード**: 表示しているポートフォリオ全体や、分析ページの保有銘柄一覧をCSVファイルとしてダウンロードできます。
- **購入注目フラグ (Buy Signal)**: 「質の高い銘柄」が「十分に調整」され、「反転し始めた」瞬間をシステム的に判定し、アイコン（🔥や💎など）で表示します。
    - **2段階のシグナル**: 十分に売られた状態の「準備（🟡）」と、5日線突破などで反転を確認した「チャンス（🔥）」を表示。
    - **ダイヤモンド評価**: ファンダメンタルズが特に優れた銘柄（6点以上）にはダイヤモンド（💎）が付与され、高確信な投資判断をサポートします。
    - **判定理由の可視化**: アイコンにホバーすることで、「RSI売られすぎ」「5日線突破」などの具体的な根拠を確認できます。
- **資産履歴の自動記録**: 分析ページを開くたびに、その時点の資産状況（評価額・損益・配当など）を月次履歴として自動的にデータベースに保存します。
これにより、将来的に資産推移を振り返ることが可能になります。
- **フロントエンドキャッシュ**: APIから取得した資産データをブラウザにキャッシュし、再読み込み時の表示を高速化します。まずキャッシュデータを表示し、その後バックグラウンドで最新情報を取得して更新します。

## 詳細な機能一覧

### 1. ポートフォリオ管理機能
- **資産の追加**
    - 国内株式、米国株式、投資信託を銘柄コード、ティッカー、ファンドコードでポートフォリオに追加する。
    - コードの形式から資産タイプ（国内株/米国株/投資信託）を自動で判別する。
- **資産の削除**
    - ポートフォリオから特定の資産を選択して一括で削除する。
- **資産情報表示**
    - 資産タイプごとにタブで表示を切り替える。
    - 各資産の最新情報を一覧で表示する（株価、前日比、時価総額など）。
    - 一覧の各項目でソート（並び替え）が可能。
    - 銘柄コードや名称で表示内容をフィルタリングする。
- **保有状況の管理**
    - 資産ごとに、複数の口座（特定口座, 一般口座, 新NISA, 旧NISA）の保有情報を登録・更新・削除できる。
    - 保有情報には「取得単価」と「数量」を記録する。
- **データ更新**
    - 「全件更新」ボタンで、ポートフォリオ内の全資産の情報を最新化する（クールダウン機能付き）。
- **CSVエクスポート**
    - 現在表示しているポートフォリオの一覧をCSVファイルとしてダウンロードする。

### 2. ポートフォリオ分析機能
- **サマリー表示**
    - ポートフォリオ全体の評価額、投資額、損益、損益率、年間配当合計などを表示する。
    - 金額表示のON/OFFを切り替えることができる。
- **グラフ表示**
    - 保有資産の構成比を円グラフで可視化する。
    - 「業種別」「口座種別」「証券会社別」「国別」での表示切り替えが可能。
- **保有銘柄一覧**
    - 全ての保有資産の詳細な情報を一覧で表示する（評価額、損益、損益率など）。
    - 銘柄名、業種、口座種別、証券会社でフィルタリングが可能。
- **分析結果のCSVエクスポート**
    - 保有銘柄一覧をCSVファイルとしてダウンロードする。

### 3. データ取得・加工機能
- **スクレイピング**
    - Yahoo!ファイナンスから以下の情報を取得する。
        - **国内株式**: 株価、企業情報（業種、決算月）、財務指標（PER, PBR, ROE, EPS）、配当情報（利回り, 過去配当履歴）。
        - **米国株式**: 株価、市場情報、財務指標（PER, EPS）、決算月。
        - **投資信託**: 基準価額、純資産総額、信託報酬。
        - **為替レート**: USD/JPYレート。
- **スコアリング（国内株式のみ）**
    - PER, PBR, ROE, 配当利回り, 連続増配年数などの指標に基づき、独自の評価スコアを算出する。
    - スコアの計算ロジックは `highlight_rules.json` で設定可能。
- **購入シグナル判定**
    - テクニカル指標（RSI, RCI, フィボナッチ, 5日移動平均線）とファンダメンタルズスコアを組み合わせ、最適な買い時を判定する。
- **データキャッシュ**
    - 取得した外部データを一定時間キャッシュし、APIへの過度なアクセスを防ぐ。

### 4. その他
- **最近追加した資産**
    - メインページで最近追加した資産のコードを一覧表示し、クリックで簡単に追加できる。
- **レスポンシブデザイン**
    - PC画面での閲覧に最適化されている。

## 主な技術

### バックエンド
- **言語**: Python 3.10+
- **Webフレームワーク**: FastAPI
- **Webサーバー**: Uvicorn
- **データ取得**: `requests`, `BeautifulSoup4` (HTMLおよびページ埋め込みJSONの解析)
- **データ永続化**: JSONファイル (`portfolio.json`, `highlight_rules.json`)

### フロントエンド
- **HTML/CSS**: Jinja2テンプレート
- **JavaScript**: ES6+, Fetch API, DOM操作
- **グラフ描画**: Chart.js

## セットアップと実行方法

1. **リポジトリをクローンします。**
   ```bash
   git clone https://github.com/your-username/jp-stock-portfolio-app.git
   cd jp-stock-portfolio-app
   ```

2. **必要なPythonライブラリをインストールします。**
   ```bash
   pip install fastapi uvicorn python-multipart requests jinja2 beautifulsoup4 cachetools
   ```

3. **FastAPI開発サーバーを起動します。**
   ```bash
   uvicorn app:app --reload
   ```

4. **ブラウザでアクセスします。**
   Webブラウザを開き、 `http://127.0.0.1:8000` にアクセスしてください。 `http://127.0.0.1:8000/analysis` で分析ページにアクセスできます。

## 使い方

- **銘柄の追加**: 画面左側の操作パネルにある入力フォームに4桁の銘柄コードを入力し、「追加」ボタンをクリックします。
- **保有情報の管理**: 一覧の「管理」ボタンから、銘柄の取得単価と数量を登録・更新できます。
- **ポートフォリオ分析**: サイドバーの「ポートフォリオ分析ページへ」リンクから、保有銘柄に特化した分析ページへ移動できます。
- **銘柄の削除**: 一覧テーブルの各行にある「削除」ボタンをクリックします。
- **データ更新**: ページをリロードすると、まずキャッシュされたデータが即座に表示され、その後バックグラウンドで全銘柄の最新情報が自動的に再取得・更新されます。手動で即時更新したい場合は、サイドバーの「全件更新」ボタンを使用します。
- **ソート**: 一覧テーブルのヘッダー（「総合評価スコア」や「連続増配」など）をクリックすると、その列のデータで昇順・降順にソートされます。
- **詳細情報の確認**: 
    - 「総合評価スコア」の星にマウスカーソルを合わせると、評価の内訳が表示されます。
    - 「連続増配」のバッジにマウスカーソルを合わせると、過去10年間の配当履歴が表示されます。
    - 「連続増配」のバッジをクリックすると、Yahoo!ファイナンスの配当詳細ページが開きます。
- **CSVダウンロード**: 左側の操作パネルにある「CSVをダウンロード」ボタンをクリックすると、表示されているポートフォリオがCSVファイルとして保存されます。
- **ハイライト基準の変更**: `highlight_rules.json` ファイルを編集することで、指標がハイライトされる基準（PERの閾値や連続増配の評価年数など）、総合スコアの閾値、および購入注目フラグの判定基準（RSI/RCI等）を自由に変更できます。

## データ管理と一括編集

本アプリのポートフォリオデータは、ルートディレクトリの `portfolio.json` に保存されています。UIからの操作以外に、このファイルを直接編集することで、データのバックアップや一括更新が可能です。

### portfolio.json の構造
各銘柄の `holdings` 配下に、口座ごとの保有情報が格納されています。
```json
{
    "code": "7203",
    "asset_type": "jp_stock",
    "currency": "JPY",
    "holdings": [
        {
            "id": "uuid-string",
            "account_type": "特定口座",
            "security_company": "SBI証券",
            "purchase_price": 2000.0,
            "quantity": 100.0,
            "memo": "長期保有"
        }
    ]
}
```

### 手動編集時の注意点
- **バックアップ**: 編集前に必ずファイルのコピーを取っておくことを推奨します。
- **JSON形式**: カンマの有無など、JSONの構文が正しいことを確認してください。
- **IDの維持**: `id` フィールドはアプリ内部で使用しているため、既存データの値を変更しないでください。
- **反映**: ファイルを保存後、ブラウザでページをリロードすると変更が反映されます。

## 処理フロー

### データ表示フロー
```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Browser as ブラウザ (JS)
    participant API as FastAPIバックエンド
    participant Scraper as Webスクレイパー
    participant Portfolio as portfolio.json
    participant Rules as highlight_rules.json
    participant RecentStocks as recent_stocks.json

    User->>Browser: ページ読み込み
    Browser->>API: GET /api/stocks (全銘柄データ要求)
    Browser->>API: GET /api/highlight-rules (ハイライトルール要求)
    Browser->>API: GET /api/recent-stocks (直近追加銘柄要求)
    
    API->>Portfolio: 銘柄コードリスト読み込み
    API->>Rules: ハイライトルール読み込み
    API->>RecentStocks: 直近追加銘柄リスト読み込み
    Rules-->>API: ルールJSON
    Portfolio-->>API: ["7203", "9432", ...]
    RecentStocks-->>API: ["1234", "5678", ...]
    
    API->>Scraper: 各銘柄コードのデータ取得を並行依頼
    Scraper-->>API: 銘柄データ (株価, PER, 配当履歴など)
    
    API->>API: 連続増配年数を計算 (配当維持は含めず、増配のみカウント)
    API->>API: 総合評価スコアを計算
    API->>API: 購入注目フラグ (Buy Signal) を判定
    API->>API: 保有銘柄の評価額・損益などを計算
    API-->>Browser: JSON (計算済み銘柄データリスト)
    API-->>Browser: JSON (ハイライトルール)
    API-->>Browser: JSON (直近追加銘柄リスト)
    
    Browser->>User: ルールに基づきハイライトし、スコア(★)や連続増配バッジと共にテーブルを描画
    Browser->>User: 直近追加銘柄リストを表示
```

### CSVダウンロードフロー
```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Browser as ブラウザ (JS)
    participant API as FastAPIバックエンド
    participant Scraper as Webスクレイパー
    participant Portfolio as portfolio.json

    User->>Browser: CSVダウンロードボタンをクリック
    Browser->>API: GET /api/stocks/csv (CSVデータ要求)
    
    API->>Portfolio: 銘柄コードリスト読み込み
    Portfolio-->>API: ["7203", "9432", ...]
    
    API->>Scraper: 各銘柄コードのデータ取得を並行依頼
    Scraper-->>API: 銘柄データ (株価, PER, 配当履歴など)
    
    API->>API: 連続増配年数を計算
    API->>API: 総合評価スコアを計算
    API->>API: 全データからCSVを生成
    
    API-->>Browser: CSVファイル
    Browser->>User: ファイルをダウンロード
```

### 銘柄追加フロー
```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Browser as ブラウザ (JS)
    participant API as FastAPIバックエンド
    participant Scraper as Webスクレイパー
    participant Portfolio as portfolio.json
    participant RecentStocks as recent_stocks.json

    User->>Browser: 銘柄コードを入力し「追加」ボタンをクリック
    Browser->>API: POST /api/stocks (銘柄追加要求)
    
    API->>Portfolio: 銘柄コードをリストに追加し保存
    
    alt データ取得成功
        API->>Scraper: 銘柄データ取得
        Scraper-->>API: 銘柄データ
        
        API->>RecentStocks: 銘柄コードを直近追加リストに追加し保存
        
        API-->>Browser: 成功メッセージと銘柄データ
        Browser->>User: メッセージ表示、ポートフォリオ一覧と直近追加銘柄リストを更新
        
    else データ取得失敗 (銘柄が存在しない等)
        API->>Scraper: 銘柄データ取得
        Scraper-->>API: エラー情報
        
        API->>Portfolio: 追加した銘柄コードをリストから削除 (ロールバック)
        
        API-->>Browser: 失敗メッセージ
        Browser->>User: エラーメッセージを表示
    end
```

## next step
- **[UI改善]分析ページの注目フラグのみ表示するフィルタを追加する**: 現在分析ページの注目フラグつき銘柄が参照可能だが、メインページと同じようにフィルタして対象銘柄のみを表示可能にしたい。
- **ポートフォリオ特性のさらなる可視化 (レーダーチャート)**: [フェーズ3]現在の分析結果（DNA, 分散度, トレンド等）をレーダーチャートに統合。ポートフォリオの「強み」と「弱み」をひと目で把握できるようにする。
- **パフォーマンス改善**: 登録銘柄数が数百件規模に増えた場合にも、軽快な動作を維持するための改善。
    - **バックエンド**:
        - **永続キャッシュの導入**: Redis等を導入してサーバー再起動後もキャッシュを維持し、データ取得時間を短縮。
        - **リクエスト数の制御**: `asyncio.Semaphore`などを利用し、外部APIへの同時リクエスト数を制限して安定性を向上。
    - **フロントエンド**:
        - **APIのページネーション対応**: 全件取得APIをページネーション化し、初期読み込みデータ量を削減。
        - **仮想スクロールの実装**: 大量データのテーブル表示において、画面表示領域のみを描画することで、ブラウザのレンダリング負荷を軽減。
- **UI/UXのさらなる向上**: ユーザーからのフィードバックに基づく継続的な改善。
- **テストコードの拡充**: より安定したアプリケーションのための単体テスト・結合テストの追加。


---
### 現在の課題 (2026/02/26 時点)

---

## 開発者向けガイドライン

### 1. フロントエンドのキャッシュ対策
JavaScript (`static/js/`) や CSS (`static/css/`) を修正した場合、ブラウザが古いキャッシュを読み込み続けることがあります。変更を確実に反映させるため、必ず呼び出し元の HTML ファイル内のバージョン番号（クエリパラメータ）をインクリメントしてください。

- **対象ファイル**: `templates/index.html`, `templates/analysis.html`
- **修正例**:
  ```html
  <!-- v=1.10 を v=1.11 に更新 -->
  <script src="/static/js/analysis.js?v=1.11"></script>
  ```

### 2. グラフ (Chart.js) 追加時のルール
新しいグラフを追加する際は、Chart.js が描画領域を正しく計算できるように、必ず以下の構造を守ってください。

- **HTML**: `canvas` タグを `.chart-container` クラスを持つ `div` で囲む。
- **CSS**: `.chart-container` に `position: relative` と具体的な `height`（例: `300px`）を指定する。
- **JS**: 再描画時にエラーが発生しないよう、既存の Chart インスタンスがある場合は `destroy()` してから新規作成する。

---

## 対応済みの課題

### 購入注目フラグ (Buy Signal) のUI刷新 [UI改善] (2026/02/28 対応)
- **対応**: 従来の絵文字アイコンから、モダンなバッジ形式のUIにアップデートしました。
  - **視認性向上**: 「注目」「チャンス」「高確信」といったテキストラベルとアイコンを組み合わせ、意味を直感的に把握可能に。
  - **レベル別デザイン**: 🟡（注目）、🔥（チャンス/パルスアニメ）、💎（厳選/シマーエフェクト）の3段階で色分けとアニメーションを適用。
  - **分析ページ統合**: ポートフォリオ分析ページの保有銘柄一覧にもバッジを表示し、保有株の買い時を特定しやすく改善。

### ポートフォリオ特性 (Radar Chart) の安全性ロジック刷新 (2026/02/26 対応)
- **対応**: ユーザーの投資ポリシーに基づき、安全性の評価軸を抜本的に見直しました。
  - **投資信託**: 分散が効いているため一律で100点（安全）として評価。
  - **米国個別株**: 情報取得のリスクを考慮し、ウォッチ銘柄として一律10点（リスク）として評価。
  - **国内個別株**: 「ディフェンシブ業種」「時価総額（3,000億/1兆）」「連続増配3年以上」「PBR1.2倍以下」の4項目で各25点の加点方式とし、赤字（ROE < 0）の場合はスコアを半減させる厳格な判定を導入。
  - **分散度補正**: HHI指数が2500を超える集中投資状態の場合、安全性スコア全体に 0.9 倍のペナルティを課すロジックを実装。

### 米国株式の価格・時価総額表示の適正化 (2026/02/26 対応)
- **対応**: 通貨の混在による誤解を防ぐため、ヘッダーと表示内容を整理しました。
  - **現在値**: 米国株はドル建てでの表示であることを明示するため、ヘッダーを「現在値 ($)」または「現在値 (外貨)」に変更。
  - **時価総額**: スクレイパー側で円換算済みであることを明示するため、ヘッダーを「時価総額 (円)」に変更。

### 前日比（比率）の表記統一 [UI改善] (2026/02/26 対応)
- **対応**: 国内株式、米国株式において欠落していた前日比の `%` 表記を追加し、投資信託と合わせて全資産タイプで表記を統一しました。データ形式をバックエンドで正規化し、フロントエンドで一括して単位を付与する設計に刷新しました。

### 決算月表示の不具合修正 (2026/02/25 対応)
- **原因**: Yahoo!ファイナンスの一部ページ（国内株の企業情報など）が Next.js による動的レンダリングに移行したことで、従来の `window.__PRELOADED_STATE__` を用いた JSON 解析ロジックが機能しなくなっていました。
- **対応**: スクレイピングロジックを刷新し、BeautifulSoup による HTML 解析ベースの取得方式に変更しました。また、米国株についても同様の変更に備え、JSON 解析に失敗した場合のフォールバック処理を導入し、取得の安定性を向上させました。

### ポートフォリオ性格診断 (Style Analysis) の実装 [新機能] (2026/02/22 対応)
- **対応**: 保有銘柄の特性から資産全体の性格を自動判定し、視覚化する機能を実装しました。
  - **判定項目**: 「景気敏感/ディフェンシブ」「バリュー/グロース」「大型株/中小型株」の3つの軸で算出。
  - **診断結果**: 比率が高い要素を組み合わせた簡易的な性格診断メッセージ（一言診断）を表示。
  - **スタックバー表示**: 各スタイルの比率を横棒グラフで直感的に確認できるよう改善。
  - **互換性**: 既存のDNA分析や分散度分析と並列して動作し、フィルタリングにも完全対応。

### ポートフォリオ特性分析 (DNA & Risk) の実装 [新機能] (2026/02/22 対応)
- **対応**: 個別銘柄ではなく「ポートフォリオ全体」を一つのチームとして分析する機能を実装しました。
  - **ポートフォリオのDNA**: 保有額を考慮した加重平均により、全体のPER、PBR、ROE、利回りを算出。市場平均との比較やスタイルの客観視が可能に。
  - **分散度・リスク分析**: HHI指数と上位5銘柄占有率を計算。集中投資によるリスクを視覚化し、「良好」「集中リスクあり」などの診断を表示。

### 配当利回りのリカバリ対応 [改善] (2026/02/20 対応)
- **対応**: Yahoo!ファイナンスから「配当利回り」が取得できない（`N/A`や`--`）場合に、取得済みの「予想年間配当金」と「現在株価」から利回りを自動計算して補完するロジックを実装しました。
  - **メリット**: データ欠損による「総合評価スコア」の低下や「購入注目フラグ」の判定漏れを防止し、より正確な投資判断をサポートします。

### バックエンド定数の外部設定化（リファクタリング） (2026/02/18 対応)
- **対応**: `app.py` にハードコードされていた各種定数（スコア閾値、購入注目フラグの基準、クールダウン時間など）を `highlight_rules.json` に集約しました。
  - **get_configの導入**: 設定ファイルからの安全な値取得と型変換を行うヘルパー関数を導入。設定ファイルが不足していてもデフォルト値で動作する堅牢な設計に刷新。
  - **柔軟な調整**: アイコン、ラベル名、テクニカル指標の閾値などをコード修正なしで変更可能に。

### 購入注目フラグ (Buy Signal) の実装 (2026/02/16 対応)
- **対応**: 銘柄の「質」と「買い時」を自動判定し、視覚化する機能を実装しました。
  - **判定ロジック**: 「ファンダメンタルズ（業績・割安性）」×「調整（RSI/RCI/フィボナッチ）」×「反転（5日線突破/RSI反転）」の3レイヤーで判定。
  - **ランク分け**: 質の高い銘柄（ファンダ6点以上）を「ダイヤモンド💎」として特別視。
  - **UI表示**: 銘柄名の横に 🔥 などのアイコンを表示し、ホバーで「判定理由」を詳細表示。
  - **フィルタ**: サイドバーから注目銘柄のみを抽出できるフィルタ機能を追加。

### 分析ページの配当分析の不具合修正と名称変更 (2026/02/09 対応)
- **対応**: 分析ページの「保有銘柄一覧」における配当分析の不具合を修正し、指標の名称をより適切なものに変更しました。
  - **不具合修正**: フィルタ（業種や口座など）を適用した際に、配当構成比が「表示されている銘柄のみ」を基準に再計算されてしまう問題を解消しました。常にポートフォリオ全体に対する貢献度が正しく表示されるよう修正しました。
  - **名称変更**: 「配当比率 (%)」という名称が配当利回りと混同されやすかったため、ポートフォリオ内の構成割合であることを示す「**配当構成比 (%)**」へと変更しました。
  - **波及修正**: テーブルヘッダー、CSV出力、および README 内の関連記述をすべて新名称に統一しました。

### テクニカル指標（フィボナッチ・RCI）への説明ツールチップ追加 (2026/02/07 対応)
- **対応**: 専門的なテクニカル指標である「フィボナッチ」と「RCI(26)」の各項目について、その意味や投資判断の基準を即座に確認できるよう改善しました。
  - **ツールチップ実装**: 各ページのテーブルヘッダーに `title` 属性を追加し、マウスホバー時に説明文を表示。
  - **内容**: フィボナッチ（押し目買い圏内の目安）、RCI（底値圏の判断基準）を明記し、初心者でも指標を活用しやすくしました。

### 資産推移・配当積み上げの可視化（グラフ化） (2026/02/05 対応)
- **対応**: 蓄積された履歴データに基づき、資産の成長と配当金の推移を視覚化しました。
  - **資産推移グラフ**: 「総資産額」と「投資元本」を折れ線グラフで表示。含み損益の推移を把握可能に。
  - **配当推移グラフ**: 月ごとの「年間配当予定額」を棒グラフで表示。インカムゲインの成長を可視化。
  - **プライバシー配慮**: 「金額を隠す」機能と連動し、グラフ上の数値もマスクされるよう実装。
  - **キャッシュ対策**: バージョン管理による確実な JS 反映の仕組みを導入。

### 月次資産推移のDB記録基盤の構築 (2026/02/03 対応)
- **対応**: 毎月末時点の資産状況を時系列で記録するためのバックエンド基盤を構築しました。
  - **SQLite導入**: 履歴管理用に `portfolio_history.db` を新規作成し、既存の `portfolio.json` とは独立してデータを管理する安全な設計を採用。
  - **自動スナップショット**: ユーザーが「分析ページ」を開いたタイミングで、その月の最新のポートフォリオ状況（銘柄ごとの評価額、損益、配当など）を自動でDBに保存・更新する仕組みを実装。
  - **API追加**: 履歴データのサマリーを取得するAPIを作成（将来のグラフ化用）。

### 総合評価スコアの表示色分け対応 (2026/02/03 対応)

### 総合評価スコアのトレンド対応と拡張 (2026/02/02 対応)

### 分析ページの配当金分析機能の強化 (2026/02/01 対応)
- **対応**: ポートフォリオにおける配当金の構造を詳細に分析・可視化する機能を追加しました。
  - **サマリー**: 配当が出る銘柄のみを対象とした「配当利回り（現在値ベース）」および「配当利回り（取得値ベース/YOC）」の表示を追加。無配の資産（再投資型投資信託など）を分母から除外することで、実効的なインカムゲイン効率を把握可能に。
  - **グラフ**: グラフ切り替えに「配当構成（業種別）」を追加。どの業種が配当金の柱になっているかを視覚化。
  - **テーブル**: 保有銘柄一覧に「配当構成比 (%)」列を追加。各銘柄がポートフォリオ全体の配当金にどれだけ貢献しているかを算出。
  - **CSV**: 分析ページのCSV出力に「配当構成比 (%)」を追加。
### 分析ページの証券会社フィルタ・グラフ対応 (2026/01/28 対応)
- **対応**: 分析ページにおいて、登録された「証券会社」情報に基づくフィルタリング機能と、構成比円グラフの表示機能を追加しました。
  - **フィルタ**: 保有銘柄一覧を特定の証券会社で絞り込み、その状態でのサマリー（合計評価額など）を確認できるようになりました。
  - **グラフ**: ポートフォリオ構成グラフに「証券会社別」の切り替えボタンを追加し、資産の分散状況を視覚的に把握できるようにしました。

### 設定ファイル(`portfolio.json`)の構文エラー検知と通知機能 (2026/01/27 対応)
- **対応**: `portfolio.json` を手動編集した際に構文エラー（カンマの重複など）があると、アプリがエラーを出さずにデータが表示されなくなる問題を解消しました。
  - **バックエンド**: JSON パースエラーを明示的にキャッチし、具体的なエラー内容と修正のヒント（JSON Lintへのリンク等）を含むエラーレスポンスを返すように変更。
  - **フロントエンド**: エラーメッセージを HTML 形式でアラート表示できるように拡張し、ユーザーが即座に原因を特定して修正できるように改善。

### 保有銘柄情報の登録項目の拡充 (2026/01/24 対応)
- **対応**: 保有管理情報に「預け先証券会社」と「備考（メモ）」の項目を追加しました。
  - `security_companies.json` で証券会社の選択肢を管理可能に。
  - メインページの保有管理モーダルで入力・更新ができるように UI を拡張。
  - 分析ページのテーブルおよび CSV 出力に「証券会社」と「備考」列を追加。
  - 既存データとの互換性を維持し、未入力項目があっても正常に動作するように堅牢化。

### ポートフォリオ分析のフィルタとサマリーの連動 (2026/01/19 対応)
- **原因**: 分析ページの保有銘柄一覧でフィルタ（テキスト、業種、口座）を適用しても、ページ上部のサマリー情報（総評価額、総損益など）がフィルタ前の全資産の合計値を表示し続けていた。これは、サマリー計算処理が常にフィルタリング前の全データリストを参照していたため。
- **対応**: `static/js/analysis.js` を修正。サマリーを計算する `renderSummary` 関数が、フィルタリング後のデータリストを引数として受け取るように変更。フィルタが適用されるたびに、フィルタ後のデータでサマリーが再計算され、表示が動的に更新されるようにした。

### 分析ページのクールダウン表示の動的化 (2026/01/13 対応)
- **原因**: メインページから分析ページへ短時間で遷移した際、APIのクールダウン中に表示される「データ更新中です...」というメッセージが静的で、残り時間が分からなかった。
- **対応**: `static/js/analysis.js` を修正し、クールダウン中のメッセージが「あと X 秒」のように1秒ごとにカウントダウンする動的な表示になるように変更。これにより、ユーザーはデータが表示されるまでの待ち時間を正確に把握できるようになった。

### ページ遷移時のデータ表示に関するUI/UX改善 (2026/01/11 対応)
- **対応**:
  - `static/js/stateManager.js`にクールダウン残り時間取得関数`getCooldownRemainingTime`を追加。
  - `templates/analysis.html`にローディングインジケーターを追加。
  - `static/js/analysis.js`に、クールダウン中の自動再試行ロジックとローディング表示を実装。
  - `static/js/main.js`および`static/js/analysis.js`に、ページ遷移時に進行中の`fetch`リクエストをキャンセルするための`AbortController`と`pagehide`イベントリスナーを導入。

### 米国株式の時価総額表示の修正 (2026/01/07 対応)
- **原因**: バックエンドがドル建ての時価総額を円換算せずにフロントエンドに渡しており、フロントエンド側でその数値を円として解釈してしまっていたため、誤った金額（例: NVDAが約45億円）で表示されていました。
- **対応**: `scraper.py`の米国株式データ取得ロジックを修正。Yahoo!ファイナンスから取得したドル建ての時価総額（例: `4.55兆ドル`）に、為替レート（USD/JPY）を掛けて円換算する処理を追加しました。これにより、NVDAの時価総額が「約720兆円」のように正しく表示されるようになりました。

### 時価総額表示の安定化 (2026/01/04 対応)
- **原因**: 夜間など特定の時間帯に、Yahoo!ファイナンスから返される国内株式の時価総額データの形式が、通常の文字列形式から辞書形式へと変更されることが原因で、データが取得できず「N/A」と表示されていました。
- **対応**: `scraper.py` の国内株式データ取得ロジックを修正。時価総額のデータが文字列形式でも辞書形式でも、両方に対応できるよう堅牢化し、時間帯に依存せず安定して表示できるようにしました。

### 年間配当の税金計算機能の追加 (2025/12/31 対応)
- **対応**: ポートフォリオ分析ページにおいて、年間配当の税引き後（手取り）金額を表示する機能を追加しました。
  - `tax_config.json` ファイルを新設し、国内株式や米国株式などの資産タイプに応じた税率を外部から設定可能にしました。
  - NISA口座などの非課税口座と、特定口座などの課税口座を自動で判別し、課税口座の配当金にのみ税率を適用して税引き後金額を計算します。
  - 分析ページのサマリーと保有銘柄一覧の両方で、税引き前と税引き後の年間配当額を確認できます。

### ポートフォリオ一覧のフィルタ機能強化 (2025/12/27 対応)
- **対応**: ポートフォリオ一覧ページに「保有銘柄のみ表示」フィルタを追加しました。これにより、ユーザーは実際に保有している銘柄のみを一覧に表示し、評価スコアや前日比などでソート・比較することが可能になりました。(#27)

### 決算月表示機能の追加 (2025/12/23 対応)
- **対応**: 国内株式・米国株式について、それぞれの決算月をYahoo!ファイナンスから取得し、ポートフォリオ一覧に表示する機能を追加しました。データソースとして、ページに埋め込まれたJSONデータを解析する方式を採用し、安定した情報取得を実現しています。

### 指標ハイライト機能の不具合とデグレの修正 (2025/12/10 対応)
- **原因**: Yahoo!ファイナンスのデータ構造が一部変更され、特定の指標（PERなど）がオブジェクト形式と文字列形式の両方で返されるようになった。この不整合に `scraper.py` が対応できず、メインページでの指標ハイライト機能が停止。また、このエラーが原因で、分析ページのAPIでサーバーエラー（500）が発生するデグレも引き起こしていた。
- **対応**: `scraper.py` のデータ取得ヘルパー関数を、オブジェクトと文字列の両方のデータ形式を正しく処理できるように修正。これにより、指標ハイライト機能が復旧し、同時に分析ページのデグレも解消された。

### 資産追加時の通知機能の修正 (2025/12/08 対応)
- **原因**: 資産追加APIが成功時に返すJSONに、フロントエンドが通知表示に必要とする`message`キーが含まれていなかった。
- **対応**: `app.py`を修正し、APIの成功レスポンスにメッセージを含めることで、資産追加時に画面右上で成功通知が正しく表示されるようにした。

### UI改善とバックエンド修正 (2025/12/04 対応)
- **ポートフォリオ一覧のUI修正**:
  - ユーザーの要望に基づき、国内株式一覧テーブルから「市場」の列を削除し、表示をシンプルにしました。
- **分析ページのCSV出力修正**:
  - 分析ページからダウンロードされるCSVファイルに不要な「市場」データが含まれていた問題を修正しました。
- **CSVダウンロード機能の不具合修正**:
  - ポートフォリオ一覧ページのCSVダウンロード機能が、FastAPIのルーティング順序の問題で動作していなかった不具合を修正しました。APIエンドポイントの定義順序を調整し、正常に機能するようにしました。

### バックエンドキャッシュの修正 (2025/12/02 対応)
- `scraper.py`の`get_scraper`関数が毎回新しいスクレイパーインスタンスを生成していたため、キャッシュが機能していなかった問題を修正。これにより、セッション中の不要なスクレイピングを抑制。

### ポートフォリオ分析ページの年間配当表示の復旧 (2025/12/02 対応)
- `templates/analysis.html`に年間配当のテーブルヘッダーを追加。
- `static/js/analysis.js`で`item.estimated_annual_dividend`を参照するように修正し、年間配当合計もサマリーに表示されるように修正。
- `app.py`の`display_keys_to_convert`に`"estimated_annual_dividend"`を追加。
- `scraper.py`が会社予想の年間配当を正しく取得できていなかった問題を修正。
- 年間配当のソートが機能していなかった問題を、`templates/analysis.html`の`data-key`を`"estimated_annual_dividend"`に修正することで解決。

### ポートフォリオ分析ページの「市場」項目を非表示化 (2025/12/02 対応)
- ユーザーの要望により、`templates/analysis.html`から「市場」の`<th>`要素を削除し、`static/js/analysis.js`から関連する`createCell`呼び出しを削除。
- 不要になったCSSセレクタも削除。

### ポートフォリオ分析ページの損益率の色付け修正 (2025/12/02 対応)
- 損益率の文字色だけでなく背景色も変更し、メインページのPERなどと同様の薄い緑/赤の背景色になるように`static/css/style.css`の`profit`と`loss`クラスを定義し、`static/js/analysis.js`でこれらのクラスを適用するように修正。

### ポートフォリオ分析ページの「金額を隠す」機能の復旧と拡張 (2025/12/02 対応)
- `static/css/style.css`に`masked-amount`クラスの定義を追加し、機能が動作するように復旧。
- 数量、取得単価、年間配当、およびグラフのツールチップの金額も隠せるように機能を拡張。

### ポートフォリオ分析ページのポートフォリオ構成グラフ表示の復旧 (2025/12/02 対応)
- `static/js/analysis.js`のグラフ描画ロジックを修正し、`templates/analysis.html`の`<canvas>`要素を正しく参照するように変更。

### 米国株式の時価総額表示の修正 (2025/12/02 対応)
- `static/js/main.js`の`renderUSTable`関数内の`item`参照エラーを`usStock`に修正し、米国株式の情報が表示されない問題を解決。
- 時価総額が正しく表示されるように修正。

### フロントエンドキャッシュとUI改善 (2025/11/30 対応)
- **フロントエンドキャッシュの実装**:
  - APIから取得した資産データをブラウザの`localStorage`にキャッシュするように変更。ページ再読み込み時に、まずキャッシュされたデータを表示することで、体感速度を向上させた。
  - データの追加・更新・削除時にはキャッシュも同期して更新し、整合性を維持。
- **「全件更新」ボタンのクールダウン機能**:
  - 「全件更新」ボタンに10分間のクールダウンを導入し、短時間での連続的なAPIリクエストを防止。クールダウン中はボタンが無効化され、残り時間が表示されるようにした。

### 分析ページの表示改善と安定性向上 (2025/11/27 対応)
- **業種情報の追加**: 分析ページの「保有銘柄一覧」に「業種」列を追加し、各銘柄の業種を確認できるように改善。
- **データ処理の安定化**: 分析データ生成時の計算ロジックを改善。現在値などが取得・変換できない場合でも、その銘柄がリストから除外されることなく、該当項目が「N/A」と表示されるように修正し、安定性を向上させた。

### 投資信託対応とUI改善 (2025/11/25 対応)
- **投資信託のデータ取得機能の安定化**:
  - データ取得方法を、HTML解析からページ埋め込みJSON (`__PRELOADED_STATE__`) の解析に切り替え、基準価額、純資産総額、信託報酬などの主要な情報を安定的に取得できるように修正。
  - 前日比のパーセンテージ表示で括弧が二重になる不具合を修正。
- **保有数量の小数点対応**:
  - 投資信託の保有数量について、管理画面での小数点以下の入力および表示に対応。
  - 分析ページの保有銘柄一覧でも小数点以下の数量を表示するように修正。
- **UIの視認性向上**:
  - サイドバーの「全件更新」ボタンが背景に埋もれて見えにくかった問題を解消し、青系の目立つデザインに変更。

### 分析ページの機能強化とプライバシー保護 (2025/11/19 対応)
- **対応**:
  - **複合フィルタ機能の追加**: 分析ページの「保有銘柄一覧」に、従来のテキストフィルタ（銘柄コード/銘柄名）に加え、「業種」と「口座種別」で絞り込むためのドロップダウンフィルタを追加。複数の条件を組み合わせて、より詳細な分析が可能になった。
  - **金額表示の目隠し機能**: 分析ページに「金額を隠す」チェックボックスを設置。プライバシー保護のため、チェックを入れるとサマリー、テーブル、グラフ内のすべての金額関連情報が「***」でマスクされるようにした。

### 分析ページの機能改善 (2025/11/19 対応)
- **対応**:
  - **ソート機能の追加**: 分析ページの「保有銘柄一覧」テーブルに、メインページと同様の列ごとのソート機能を追加。`main.js`のロジックを参考に`analysis.js`を修正し、クリックされたヘッダーに応じてデータを昇順・降順に並び替えられるようにした。
  - **グラフ表示の改善**: 業種別ポートフォリオなどで円グラフが小さく表示される問題を改善するため、CSSを調整してグラフ表示エリアの横幅を広げ、視認性を向上させた。

### 分析ページのテーブル表示バグ修正 (2025/11/18 対応)
- **原因**: CSSの`position: sticky`（追従ヘッダー）が、カードヘッダーとテーブルヘッダーで二重に設定（入れ子状態）されていたため、ブラウザのレンダリングに不具合が発生し、テーブルの2行目がヘッダーに重なって表示されていた。
- **対応**: カードヘッダーの`sticky`指定を解除し、テーブルヘッダー(`thead`)のみが追従するようにCSSを修正。`sticky`の複雑な入れ子構造を解消し、表示を正常化した。

### ポートフォリオ分析ページのUI/UX改善 (2025/11/13 対応)
- **対応**:
  - **2カラムレイアウト導入**: 視認性向上のため、サマリー/グラフ（左カラム）と保有銘柄一覧（右カラム）を分割する2カラムレイアウトを導入。
  - **円グラフの視認性改善**: 業種が多数表示された際の視認性を改善するため、円グラフのカラーパレットをより多くの色を含むものに更新。
  - **UI調整**: 利便性向上のため、保有銘柄一覧のCSVダウンロードボタンをテーブル上部に移動し、デザインを調整。
  - **その他**: ユーザー個別の設定ファイルである `recent_stocks.json` を `.gitignore` に追加し、リポジトリの管理対象から除外。

### データキャッシュの導入 (2025/11/12 対応済み)
- **対応**: `scraper.py`に`cachetools`ライブラリを導入し、Yahoo!ファイナンスからのデータ取得結果を1時間キャッシュするようにした。これにより、APIへのアクセス負荷を軽減。

### フロントエンドの差分更新と手動更新機能 (2025/11/12 対応済み)
- **対応**: 銘柄の追加、削除、保有情報の更新時にページ全体を再読み込みするのではなく、JavaScriptで必要な部分のみを動的に更新するように変更。また、UIに「全件更新」ボタンを追加し、ユーザーが手動で全データをリフレッシュできるようにした。

### 前日比のソートを比率に変更 (2025/11/12 対応済み)
- **対応**: ポートフォリオ一覧の「前日比」列のソートを、金額ではなく前日比率で行うように変更した。

### 複数口座対応の保有管理機能と分析ページの強化 (2025/11/10 対応済み)
- **対応**:
  - **データ構造の再設計**: 1つの銘柄に対して複数の口座（特定、一般、旧NISA、新NISAなど）での保有情報を個別に管理できるようデータ構造を根本的に再設計。既存の単一保有情報から複数口座形式への自動データ移行ロジックを実装。
  - **保有管理APIの整備**: 個別の保有口座情報（追加・更新・削除）を操作するためのAPIを実装。利用可能な口座種別リストを返すAPIも追加。
  - **保有管理UIの刷新**: メインページから開くモーダルで、各銘柄の保有口座情報を一覧表示し、追加・編集・削除が可能に。
  - **分析ページの強化**: 保有口座ごとに詳細な情報（評価額、損益など）を表示するようテーブルを再設計。業種別および口座種別ごとの評価額構成比を円グラフで可視化。
  - **CSVダウンロードの更新**: 分析ページの新しいテーブル構造に合わせたCSVダウンロード機能を更新。

### ソート機能の不具合修正 (2025/11/10 対応済み)
- **原因**: JavaScriptのイベントリスナー内で存在しない関数を呼び出していたため、ソート機能が動作していなかった。
- **対応**: `main.js`内の誤った関数呼び出しを修正し、フィルタリング機能と連携してテーブルのソートが正しく実行されるようにした。

### UI改善とエラーハンドリング強化 (2025/11/05 対応済み)
- **対応**:
  - **2カラムレイアウト導入**: 画面を左の操作パネルと右の一覧表示エリアに分割し、一覧性と操作性を向上させた。
  - **エラー表示の強化**:
    - データ取得に失敗した銘柄も、原因（「銘柄が見つかりません」など）と共にテーブル上に赤く表示するように変更。
    - 銘柄追加時に、処理結果（成功・失敗・重複）を画面右上のメッセージで通知する機能を追加。
  - **安定性の向上**: ネットワークエラー発生時に自動で再試行するリトライ処理を導入し、データ取得の成功率を高めた。
  - **開発者向け改善**: バックエンドのログ機能を強化し、エラー発生時の原因調査を容易にした。

### UI改善および評価ロジックの強化 (2025/11/04 対応済み)
- **対応**:
  - **連続増配分析機能**: 過去10年間の配当履歴から連続増配年数を計算し、バッジで表示する機能を追加。詳細な履歴はツールチップで確認可能にした。
  - **総合評価スコア改善**: 評価項目に「連続増配」を追加し、最大10点満点の評価に変更。
  - **UI/UX改善**: 連続増配バッジにYahoo!ファイナンスへの外部リンクを設定。また、スコア表示が長くなりレイアウトが崩れる問題を、星を5個x2行で表示することで修正した。

### 配当履歴表示機能の不具合修正 (2025/11/04 対応済み)
- **原因**: Yahoo!ファイナンスの仕様変更により、従来のHTML解析ロジックでは配当履歴が取得できなくなっていた。
- **対応**: ユーザーからの情報提供により、配当履歴専用ページ (`/dividend`) を発見。このページに埋め込まれているJSONデータ (`__PRELOADED_STATE__`) を解析する方式に `scraper.py` を変更し、安定的なデータ取得を実装。フロントエンドも合わせて修正し、過去数年分の配当履歴を表示できるようにした。

### UI改善：スコア名称の明確化 (2025/11/03 対応済み)
- **対応**: ポートフォリオ一覧に表示されるスコアの名称を、内容が分かりやすい「総合評価スコア」に変更した。

### スコアの可視化と評価不能時の表示改善 (2025/11/02 対応済み)
- **対応**: スコアの星印にマウスオーバーすると、点数の内訳（PER, PBR, ROE, 利回り）がツールチップで表示されるように改善した。また、評価に必要な指標が取得できずスコアが0点になる場合は、スコアを「N/A」と表示し、ツールチップで「評価指標なし」と説明するように変更した。

### 割安度分析機能の追加 (2025/11/01 対応済み)
- **対応**: PERやPBR等の指標が割安・割高かを判断するための「ハイライト機能」と、複数指標を統合した「割安度スコア」機能を追加した。

### CSVダウンロード機能の追加 (2025/11/01 対応済み)
- **対応**: ポートフォリオ一覧をCSVファイルとしてダウンロードする機能を追加した。

### データ取得の不具合修正 (2025/11/01 対応済み)
- **原因**: Yahoo!ファイナンスの仕様変更により、前日比、配当利回り等のデータが取得できなくなっていた。
- **対応**: 新しいデータ構造に合わせて`scraper.py`のデータ解析ロジックを修正した。

### 時価総額が「N/A」になる問題 (2025/11/01 対応済み)
- **原因**: `scraper.py`が参照していたYahoo!ファイナンスの内部APIの仕様が変更され、時価総額のデータ形式が変わっていたため。
- **対応**: 新しいデータ形式に対応するよう、`scraper.py`のデータ解析ロジックを修正した。
